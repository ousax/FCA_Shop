
<!DOCTYPE html>
<html lang="fr">
<head>
  <title>FCA Shop FEG</title>
  <link rel="icon" alt="FCA Shop Logo" type="image/png" href="images/fca-icon.png" width="150" height="auto" >
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Achetez des produits incroyables √† des prix √©quitables.">
  <meta property="og:title" content="FCA Shop">
  <meta property="og:description" content="Achetez des produits incroyables √† des prix √©quitables.">
  <meta property="og:url" content="https://ousax.github.io">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="buy11.css" rel="stylesheet">
</head>
<body>
  <header>
    <div class="logo-nav">
      <a href="index.html"><img src="images/fca-icon.png" alt="FCA Shop" class="logo"/>
      <nav>
      <ul class="main-nav" style="text-align: center;">
        <!-- Liens principaux avec ic√¥nes -->
        <li><a href="index.html"><i class="fas fa-store"></i> <span>Boutique</span></a></li>
        <li><a href="account.html"><i class="fas fa-user"></i> <span>Mon Compte</span></a></li>
        <li><a href="about.html"><i class="fas fa-info-circle"></i> <span>√Ä propos</span></a></li>
        <li><a href="contact.html"><i class="fas fa-envelope"></i> <span>Contact</span></a></li>
        
      </ul>
     </nav>
    <div class="actions">
      <button id="themeToggle">üåô</button>
    </div>
    <div class="languages">
            <i class="fas fa-language"></i>
            <select id="languageSelect">
              <option value="fran√ßais">Fran√ßais</option>
              <option value="anglais">Anglais</option>
              <option value="arabe">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
      </div>
    </div>
  </header>
  <main>
    <form id="orderForm">
      <h1 style="text-align: center;">vous avez fait le bon choix </h1>
  <label id="produit_choisi">Produit choisi: </label><br><br>
  <label>Nom Complet:</label>
  <input type="text" name="nom" required><br>
  <label>Adresse:</label>
  <input type="text" name="adresse" required><br>

  <label>Email:</label>
  <input type="email" name="email" required>
  <div hidden style='color: red; font-size: 15px; align-items: center; font-weight: bolder;' id="error">Email non autoris√©. Utilisez Gmail, Yahoo, Proton ou un domaine .edu</div>
  <br>
  <label>T√©l√©phone:</label>
  <input type="tel" name="phone" required>
    <div hidden style='color: red; font-size: 15px; align-items: center; font-weight: bolder;' id="error_tel">Num√©ro de t√©l√©phone invalide. Entrez entre 9 et 15 chiffres.</div><br>
  <!--<label>Moyen de paiement:</label><br>
  <input type="checkbox" id="paypalCheckbox"> PayPal<br>
  <input type="checkbox" id="cardCheckbox"> Carte Bancaire<br>

  <div id="paypalFields" class="hidden">
    <label>Email PayPal:</label>
    <input type="email" name="paypalEmail"><br>
  </div>
  <div id="cardFields" class="hidden">
    <label>Num√©ro de carte:</label><br>
    <input type="text" name="cardNumber" required><br>
    <label>Date d'expiration</label> 
    <input type="text" name="expiration" placeholder="MM/AA" maxlength="4" required><br>
    <label>CVV:</label><br>
    <input type="text" name="cvv" maxlength="4" required>
  </div> end of the old code without the icons of the payments methods-->
  <!-- Add this to your <head> to load Font Awesome -->

  <label>Moyen de paiement:</label><br>

  <i id="paypalBtn" class="fab fa-paypal payment-icon" title="PayPal">Paypal</i>
  <i id="cardBtn" class="fas fa-credit-card payment-icon" title="Carte Bancaire">Carte Bancaire</i>

  <div id="paypalFields" class="hidden">
    <label>Email PayPal:</label>
    <input type="email" name="paypalEmail"><br>
    <div hidden style='color: red; font-size: 15px; align-items: center; font-weight: bolder;' id="error_paypal_email">Email Adresse n'est pos valide</div><br>
  </div>

  <div id="cardFields" class="hidden">
    <label>Num√©ro de carte:</label><br>
    <input type="text" name="cardNumber"><br>
    <div hidden style='color: red; font-size: 15px; align-items: center; font-weight: bolder;' id="error_card">Le num√©ro de cette carte bancaire n'est pas valide</div><br>
    <label>Date d'expiration</label> 
    <input type="text" name="expiration" placeholder="MM/AA" maxlength="5"><br>
    <div hidden style='color: red; font-size: 15px; align-items: center; font-weight: bolder;' id="error_expiration">La date de cette carte bancaire n'est pas valide</div><br>
    <label>CVV:</label><br>
    <input type="text" name="cvv" maxlength="4">
    <div hidden style='color: red; font-size: 15px; align-items: center; font-weight: bolder;' id="error_cvv">CVV est erron√©</div><br>
</div>
  <button type="submit" id="submitbuy">Soumettre</button>
  <br><br>
    <button id="downloadPDF" style="display: none; background-color: aquamarine;color: black; width: 100%;">üìÑ T√©l√©charger vos informations en PDF</button> 
</form>
</div>
  </main>
  <footer>
    <p>&copy; 2025 FCA shop. Tous droits r√©serv√©s.</p>
  </footer>
  <script>
    document.getElementById("themeToggle").addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    document.getElementById("themeToggle").textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  });
    const rawProducts = [
      ["Amandes Maroc", "images/amandes.jpg", "DH", "Amandes biologiques cultiv√©es dans les r√©gions fertiles du Maroc. Croquantes et pleines de nutriments."],
      ["Miel ZCH", "images/miel.jpg", "DH", "Miel 100% naturel produit dans les montagnes de l'Atlas. Riche en antioxydants et enzymes b√©n√©fiques."],
      ["Dattes el mejhoul", "images/dattes.jpg", "DH", "Dattes premium du Maroc, sucr√©es naturellement et riches en fibres. Un super aliment √©nerg√©tique."],
      ["Jus Dattes el mejhoul", "images/jusdattes.jpg", "DH", "Jus pur de dattes sans additifs. Source naturelle d'√©nergie et de min√©raux essentiels."],
      ["Huile d'Argan", "images/zitargan.webp", "DH", "L'or liquide du Maroc. Hydrate en profondeur la peau et les cheveux. Produit selon des m√©thodes traditionnelles."],
      ["Huile d'Olive", "images/zitzitoun.jpg", "DH", "Huile d'olive extra vierge press√©e √† froid. Fruit√©e et riche en polyph√©nols antioxydants."],
      ["Safran Premium", "images/safran_.jpg", "DH", "Safran de premi√®re qualit√© r√©colt√© √† la main. Un gramme d'or rouge pour sublimer vos plats."],
      ["Eau de Rose", "images/eau.jpg", "DH", "Hydrolat de rose naturelle pour tonifier et rafra√Æchir la peau. Parfum d√©licat et propri√©t√©s apaisantes."],
      ["Th√© Marocain", "images/dekkka.jpg", "DH", "M√©lange exclusif de th√© vert et de menthe fra√Æche. La boisson traditionnelle marocaine."],
      ["Couscous Fin", "images/COUSCOUS.jpg", "DH", "Semoule de bl√© dur de qualit√© sup√©rieure. La base authentique du plat national marocain."],
      ["Tajine en C√©ramique", "images/tajines.png", "DH", "Tajine traditionnel pour une cuisson lente et savoureuse. Fabriqu√© par des artisans locaux."],
      ["Pistaches Grill√©es", "images/pistaches.jpg", "DH", "Pistaches grill√©es √† sec, sans sel ajout√©. Une collation saine et savoureuse."],
      ["Savon Noir", "images/savon.jpg", "DH", "Savon naturel au ghassoul et huile d'olive. Nettoyant profond pour le corps et le visage."],
      ["Parfum Royal Marocain", "images/bexor.jpg", "DH", "Un parfum exclusif inspir√© des essences rares du Maroc. Notes de safran, bois de santal et fleur d'oranger."],
      ["Tapis Berb√®re", "images/zarbia.jpg", "DH", "Tapis tiss√© √† la main par des artisans berb√®res. Motifs traditionnels et laine naturelle."],
      ["Collier fait main", "images/necklace.jpg", "DH", "Ce collier fait main pr√©sente un design traditionnel et est fabriqu√© avec soin √† partir de mat√©riaux naturels. C‚Äôest une pi√®ce magnifique et unique, r√©alis√©e avec amour."],
      ["Chaussures Antigravit√©", "images/Kangoo.avif", "DH", "Des chaussures r√©volutionnaires qui r√©duisent l'impact sur les articulations. Parfaites pour le fitness et la r√©√©ducation."]
    ]; // verifier wach les prix et les noms des produits sont identiques et non pas manipuler par l'utilisateur (price manipulation issue)
    // on ne peut pas connaitre le prix d'un produit car nous avons utilis√© des fonctions qui g√©n√©rent d'une mani√®re al√©atoire les prix des prodits
    // ce qui'il est conseill√© de faire pour r√©soudre ce probl√®me c'est de v√©rifier le nom du produit est de le comparer de celui dans la variable rawProducts
    const productsWithTVA = { // les taux de tva
    "Huile d'Argan": 0.20,
    "Huile d'Olive": 0.07,
    "Safran Premium": 0.07,
    "Eau de Rose": 0.20,
    "Tajine en C√©ramique": 0.20,
    "Savon Noir": 0.20,
    "Parfum Royal Marocain": 0.20,
    "Tapis Berb√®re": 0.20,
    "Collier fait main": 0.20,
    "Chaussures Antigravit√©": 0.20
  };

    const urlParams = new URLSearchParams(window.location.search); // best practice
    const price = urlParams.get("p");
    const product_name = urlParams.get("n");
    if (price && product_name) {
      const products = rawProducts.map(product => ({
        name: product[0],
      }));
      /*[...products.forEach(ele => {
        console.log(ele.name == product_name)
        switch (ele) {
          case ele.name === product_name:
            console.log("The product is the right one");
            break;
          case ele.name != product_name:
            console.log("Nope not the right product homie");
            break;
          default:
            console.log("oops you lost bro");
            break;
        }        
      })];*/
      const VNames = [...products];
      for(var i = 0;i<VNames.length; i++){
        if(VNames[i].name === product_name){
          console.log("Le produit existe")
          break;
        }
        else if(VNames[i].name != product_name && ((VNames.length-1) != i)){
          console.log("Le produit choisi n'est pas disponible pour le moment", i, VNames.length);

        }
        else{
          alert("Le produit choisi n'est pas disponible pour le moment");
          window.location.href = "index.html";
        }
      }
      /*if(){
        console.log("Le produit que vous avez choisi n'est pas disponible pour le moment!");
        window.location.href = "index.html";
      }*/
      const safeProductName = document.createTextNode(decodeURIComponent(product_name));
      const safePrice = document.createTextNode(price + ' DH');
    
      const container = document.getElementById("produit_choisi");
      container.innerHTML = ''; // Clear existing content
    
      const label = document.createElement('div');
      label.textContent = 'Produit choisi:';
      container.appendChild(label);
    
      const strong = document.createElement('strong');
      strong.appendChild(safeProductName);
      strong.appendChild(document.createElement('br'));
      strong.appendChild(safePrice);
    
      container.appendChild(strong);
    }
    else{
      // if the user visited the buy1 page without chosing a product alert and return home
      alert("Veuillez choisir un produit!");
      window.location.href = "index.html";
    }
 
  const form = document.getElementById("orderForm");
  const downloadPDF = document.getElementById("downloadPDF");
  let formDataText = '';
    const paypalBtn = document.getElementById('paypalBtn');
    const cardBtn = document.getElementById('cardBtn');
    const paypalFields = document.getElementById('paypalFields');
    const cardFields = document.getElementById('cardFields');
    const paypalFieldsInputs = paypalFields.querySelectorAll("input");
    const cardFieldsInputs = cardFields.querySelectorAll("input");
    const languageSelect = document.getElementById("languageSelect");

    paypalBtn.addEventListener('click', () => {
    const isSelected = paypalBtn.classList.contains('selected');

      if (!isSelected) {
        // Select PayPal, deselect Card
        paypalBtn.classList.add('selected');
        form.querySelector('[name="cardNumber"]').value = "";
        form.querySelector('[name="expiration"]').value = "";
        form.querySelector('[name="cvv"]').value = "";
        paypalFields.classList.remove('hidden');
        cardBtn.classList.remove('selected');
        cardFields.classList.add('hidden');
        paypalFieldsInputs.forEach(input => {
          input.disabled = false;
          input.required = true;
        });

      // Disable Credit Card fields
      cardFieldsInputs.forEach(input => {
        input.disabled = true;
        input.required = false;
      });
      } else {
        // Deselect PayPal
        paypalBtn.classList.remove('selected');
        paypalFields.classList.add('hidden');
      }
    });

    cardBtn.addEventListener('click', () => {
      const isSelected = cardBtn.classList.contains('selected');

      if (!isSelected) {
        // Select Card, deselect PayPal
        cardBtn.classList.add('selected');
        form.querySelector('[name="paypalEmail"]').value = "";
        cardFields.classList.remove('hidden');
        paypalBtn.classList.remove('selected');
        paypalFields.classList.add('hidden');
        document.getElementById("error_cvv").hidden = true;
        document.getElementById("error_card").hidden = true;
        cardFieldsInputs.forEach(input => {
          input.disabled = false;
          input.required = true;
        });

      // Disable PayPal field
      paypalFieldsInputs.forEach(input => {
        input.disabled = true;
        input.required = false;
      });
      } else {
        // Deselect Card
        cardBtn.classList.remove('selected');
        cardFields.classList.add('hidden');
      }
    });
   
  form.addEventListener("submit", function(event) {
  event.preventDefault();

  const nom = form.querySelector('[name="nom"]').value;
  const adresse = form.querySelector('[name="adresse"]').value;
  const email = form.querySelector('[name="email"]').value;
  const phone = form.querySelector('[name="phone"]').value;
  const paypalEmail = form.querySelector('[name="paypalEmail"]')?.value || '';
  const num_card = form.querySelector('[name="cardNumber"]')?.value || '';
  const expirationDate = form.querySelector('[name="expiration"]')?.value || '';
  const cvv = form.querySelector('[name="cvv"]')?.value || '';

  const paypalSelected = paypalBtn.classList.contains("selected");
  const cardSelected = cardBtn.classList.contains("selected");

  const paymentMethod = paypalSelected
    ? "PayPal"
    : cardSelected
    ? "Carte Bancaire"
    : "Non sp√©cifi√©";

  function isValidPhone(phone) {
    return /^\+?\d{9,15}$/.test(phone);
  }

  function isValidEmail(email) {
    const allowedDomains = ["gmail.com", "yahoo.com", "proton.me", "protonmail.com"];
    const parts = email.split("@");
    return parts.length === 2 && (allowedDomains.includes(parts[1].toLowerCase()) || parts[1].toLowerCase().endsWith(".edu"));
  }

  function isValidCardNumber(num_card) {
    return /^\d{13,19}$/.test(num_card.replace(/\s+/g, ""));
  }

  function isValidCVV(cvv) {
    return /^\d{3,4}$/.test(cvv);
  }
  function isValidExpirationDate(expirationDate) {
    const [month, year] = expirationDate.split("/").map(x => parseInt(x, 10));
    if (!month || !year || month < 1 || month > 12) return false;

    const now = new Date();
    const inputDate = new Date(`20${year}`, month - 1); // assuming "MM/YY"

    return inputDate >= new Date(now.getFullYear(), now.getMonth());
  }

  // Universal validations (apply to all methods)
  if (!isValidEmail(email)) {
    document.getElementById("error").hidden = false;
    return;
  } else {
    document.getElementById("error").hidden = true;
  }

  if (!isValidPhone(phone)) {
    document.getElementById("error_tel").hidden = false;
    return;
  } else {
    document.getElementById("error_tel").hidden = true;
  }

  // Payment-specific validations
  if (cardSelected) {
    if (!isValidCardNumber(num_card)) {
      document.getElementById("error_card").hidden = false;
      return;
    } else {
      document.getElementById("error_card").hidden = true;
    }

    if (!isValidCVV(cvv)) {
      document.getElementById("error_cvv").hidden = false;
      return;
    } else {
      document.getElementById("error_cvv").hidden = true;
    }
    if (!isValidExpirationDate(expirationDate)) {
    document.getElementById("error_expiration").hidden = false;
    return;
  } else {
    document.getElementById("error_expiration").hidden = true;
  }

  }
  // Now generate the receipt content
  const date = new Date().toJSON();
  const tn = `FCA_SHOP_${(Math.random() * 233494 + 334).toFixed(0)}`;
  let paymentDetails = "Informations de paiement non fournies";
  if (paymentMethod === "Carte Bancaire") {
    paymentDetails = `Num√©ro de carte: ${num_card}\nDate d'expiration: ${expirationDate}\nCVV: ${cvv}`;
  } else if (paymentMethod === "PayPal") {
    paymentDetails = `Email PayPal: ${paypalEmail}`;
  }
  PP = parseFloat(price);
  let taxRate = productsWithTVA[product_name] || 0;
  let taxAmount = (PP * taxRate).toFixed(2);
  let totalTTC = (PP + parseFloat(taxAmount)).toFixed(2);
  let tvaDetails = taxRate > 0
    ? "TVA applicable " + (taxRate * 100).toFixed(0)+"% "+ taxAmount+" DH\nMontant TTC: "+totalTTC+ "DH"
    : "Aucun taux de TVA applicable pour ce produit.";
  const INFOS = (paymentMethod==="Carte Bancaire" && (cvv!=""&&num_card!=""&&expirationDate!="")) ? `Num√©ro de carte:: ${num_card}\nDate d'expiration: ${expirationDate}\ncvv: ${cvv}` : `Email Paypal: ${paypalEmail}`;
  formDataText = `
    Ticket FCA SHOP
    Transaction N¬∞: ${tn}
    Date: ${date}
    Produit Choisi: ${product_name}
    Prix HT: ${PP.toFixed(2)} DH
    ${tvaDetails}
    Nom: ${nom}
    Adresse: ${adresse}
    Email: ${email}
    T√©l√©phone: ${phone}
    Mode de Paiement: ${paymentMethod}
    ${INFOS}
    `.trim();


  downloadPDF.style.display = "block"; // ‚úÖ Show download button for both methods
});

downloadPDF.addEventListener("click", function() {
  async function generateStyledPDF(formDataText) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // --- HEADER ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.setTextColor(0, 102, 204);
  doc.text("FCA SHOP - Re√ßu", 14, 20);

  const now = new Date().toLocaleString("fr-FR");
  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text(`Date: ${now}`, 150, 20);
  doc.line(10, 25, 200, 25);

  // Parse data
  const lines = formDataText.split('\n');
  const data = {};
  lines.forEach(line => {
    const parts = line.split(":");
    if (parts.length > 1) {
      const key = parts[0].trim();
      const value = parts.slice(1).join(":").trim();
      data[key] = value;
    }
  });

  // --- PRODUCT TABLE ---
  const productName = data["Produit Choisi"];
  const prixHT = parseFloat(data["Prix HT"].replace("DH", "").trim());
  const tvaLine = lines.find(l => l.includes("TVA applicable"));
  const match = tvaLine ? tvaLine.match(/(\d+)%\s+([\d.]+)\s+DH/) : null;

  const tvaPercent = match ? match[1] : "0";
  const tvaAmount = match ? match[2] : "0.00";
  const ttcLine = lines.find(l => l.includes("Montant TTC"));
  const prixTTC = ttcLine ? ttcLine.match(/Montant TTC: ([\d.]+)/)[1] : prixHT;

  doc.autoTable({
    startY: 30,
    head: [["Produit", "Prix HT", "TVA %", "TVA (DH)", "TTC"]],
    body: [
      [productName, `${prixHT.toFixed(2)} DH`, `${tvaPercent}%`, `${tvaAmount} DH`, `${prixTTC} DH`]
    ],
    theme: "grid",
    styles: { fontSize: 11 },
    headStyles: { fillColor: [0, 102, 204] }
  });

  // --- CUSTOMER INFO ---
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(13);
  doc.setTextColor(33);
  doc.text("Informations Client:", 14, y);

  y += 8;
  const clientFields = ["Nom", "Adresse", "Email", "T√©l√©phone"];
  clientFields.forEach(field => {
    if (data[field]) {
      doc.setFontSize(11);
      doc.text(`${field}: ${data[field]}`, 20, y);
      y += 6;
    }
  });

  // --- PAYMENT INFO ---
  y += 5;
  doc.setFontSize(13);
  doc.setTextColor(33);
  doc.text("M√©thode de Paiement:", 14, y);

  y += 8;
  doc.setFontSize(11);
  doc.setTextColor(50);

  const isCard = data["Mode de Paiement"] === "Carte Bancaire";
  if (isCard) {
    const cardNumber = data["Num√©ro de carte::"]?.replace(/\s/g, "") ?? "";
    const masked = "**** **** **** " + cardNumber.slice(-4);
    doc.text(`Carte Bancaire`, 20, y); y += 6;
    doc.text(`Num√©ro: ${masked}`, 20, y); y += 6;
    doc.text(`Expiration: ${data["Date d'expiration"]}`, 20, y); y += 6;
    doc.text(`CVV: ***`, 20, y); y += 6;
  } else {
    doc.text(`PayPal - ${data["Email Paypal"]}`, 20, y); y += 6;
  }

  // --- FOOTER ---
  doc.setFontSize(10);
  doc.setTextColor(120);
  doc.text("Merci pour votre commande !", 70, 285);

  const transactionID = data["Transaction N¬∞"];
  doc.save(`re√ßu_FCA_${transactionID}.pdf`);
}
  
  generateStyledPDF(formDataText);
  //    window.location.href = "index.html" // redirect lhomepage apres l'inpression dial re√ßu
  // vider dok les cases 
  });
</script>
</body>
</html>